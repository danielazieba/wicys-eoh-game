<!doctype html>
<meta charset = "utf-8">
<title>Hello, world!</title>
<head>
  <style>
    body {
      background-color: black;
      text-align: center;
      color: white;
      font-family: courier;
    }
  </style>
</head>
<body>
  <h2>Cybersecurity Breakfast Adventure</h2>
<script src="ga.js"></script>
<script src="plugins.js"></script>
<script>

document.addEventListener('keydown', logKey);
var display_hint = false;
var hint_index = 0;
var hints = ["Try unlocking the computer!", "Look for a password clue in the bedroom", "Check the Caesar cipher guide for ideas!", "How many lives does a cat have?"];
var hint_has_been_viewed = [false, false, false, false];
var closeWindow = false;
var password_string = " ";
var terminal_string = "";
var allowed_password_keys = ["KeyA", "KeyB", "KeyC", "KeyD", "KeyE", "KeyF", "KeyG", "KeyH", "KeyI", "KeyJ", "KeyK", "KeyL", "KeyM", "KeyN", "KeyO", "KeyP", "KeyQ", "KeyR", "KeyS", "KeyT", "KeyU", "KeyV", "KeyW", "KeyY"];
var computerUnlocked = false;
var terminal_archive = [];
var cat, cat2, cat3, message;

function logKey(e) {
//  console.log(e.code);
  if (e.code === "KeyZ") {
    display_hint = !display_hint;
    if (hint_index === 2 && hint_has_been_viewed[hint_index]) {
      hint_index++;
    }
  }
  if (e.code === "KeyX") {
    closeWindow = true;
  }

  if (gameSceneLockedScreen.visible) {
    if (allowed_password_keys.includes(e.code) && password_string.length < 18) {
      password_string += e.code[3];
    }

    if (e.code === "Enter") {
      console.log("Checking correctness of password...");
      check_password_correctness();
    }
    // add being able to delete a character as a quality of life update
    // if needed; lower priority than getting game to work
    // if (e.code === "Backspace") {
    //   password_string = password_string.slice(0, -1);
    // }
  }

  if (gameSceneTerminal.visible) {
    if (allowed_password_keys.includes(e.code) && terminal_string.length < 40) {
      terminal_string += e.code[3];
    }

    if (e.code === "Enter") {
      console.log("TO DO: process commands!");
      terminal_archive.push("$ " + terminal_string);
      terminal_string = "";
    }
    // add being able to delete a character as a quality of life update
    // if needed; lower priority than getting game to work
    // if (e.code === "Backspace") {
    //   password_string = password_string.slice(0, -1);
    // }
  }
}


function check_password_correctness() {
  if (password_string === " DELILAH") {
    closeWindow = true;
    console.log("Password correct!");
    computerUnlocked = true;
  }
}

//Create a new GA instance, and start it.
var g = ga(700, 500, setup,
  [
    "images/big-out-living.png",
    "images/kitchen.png",
    "images/step1.png",
    "images/step1_left.png",
    "images/step2.png",
    "images/step2_left.png",
    "images/standing.png",
    "images/coffee.png",
    "images/whiteboard2.png",
    "images/bedroom.png",
    "images/locked_computer.png",
    "images/terminal.png",
    "images/zoomed_in_toaster_with_background.png",
    "images/combination_lock_on_cabinet.png",
    "images/combination_lock_with_numbers_on_cabinet.png",
    "images/eceb.png"
  ]
);
g.start();

//A `setup` function that will run only once.
//Use it for initialization tasks
function setup() {
  console.log("hiiiii");
  forest = g.sprite("images/big-out-living.png");
  kitchen = g.sprite("images/kitchen.png");
  coffee = g.sprite("images/coffee.png")
  whiteboard = g.sprite("images/whiteboard2.png");
  bedroom = g.sprite("images/bedroom.png");
  locked_screen = g.sprite("images/locked_computer.png");
  terminal = g.sprite("images/terminal.png");
  zoomed_toaster = g.sprite("images/zoomed_in_toaster_with_background.png");
  lock_on_cabinet = g.sprite("images/combination_lock_on_cabinet.png");
  lock_on_cabinet_w_num = g.sprite("images/combination_lock_with_numbers_on_cabinet.png");
  eceb = g.sprite("images/eceb.png");
  //Make a sprite
  var catFrames = [
    "images/standing.png",
    "images/step1.png",
    "images/step2.png",
    "images/standing.png",
    "images/step1_left.png",
    "images/step2_left.png"
  ];

  var walkCycle = [1, 2];

  cat = g.sprite(catFrames);
  cat2 = g.sprite(catFrames);
  cat3 = g.sprite(catFrames);

  // animation states
  cat.states = {
    walkRight: [1, 2],
    walkLeft: [4,5]
  };
  cat2.states = {
    walkRight: [1, 2],
    walkLeft: [4,5]
  };
  cat3.states = {
    walkRight: [1, 2],
    walkLeft: [4,5]
  };

  //Center the cat
  g.stage.putCenter(cat);
  g.stage.putCenter(cat2);
  g.stage.putCenter(cat3);

  // THIS STARTS CAT'S ANIMATION
  cat.fps = 5;
  cat2.fps = 5;
  cat3.fps = 5;

  cat.playSequence(walkCycle);
  cat2.playSequence(walkCycle);
  cat3.playSequence(walkCycle);

  cat.loop = false;
  cat2.loop = false;
  cat3.loop = false;

  g.fourKeyController(cat, 2, 38, 39, 40, 37);
  g.fourKeyController(cat2, 2, 38, 39, 40, 37);
  g.fourKeyController(cat3, 2, 38, 39, 40, 37);
  message = g.text("Use the arrow keys to move...", "16px sans-serif", "black");
  message2 = g.text("Use the arrow keys to move...", "16px sans-serif", "black");
  message3 = g.text("Toggle current hint by pressing Z!", "30px sans-serif", "white", 50, 680);
 // message4 = g.text("Controls: arrow keys to move. X to close an item popup.", "30px sans-serif", "white", 50, 700);
  // message3.x = 0;
  // message3.y = 770;
  gameScene = g.group(forest, cat, message3);
 // gameSceneCat = g.group(cat, message);
  gameSceneKitchen = g.group(kitchen, cat2);
  gameSceneBedroom = g.group(bedroom, cat3);
  gameSceneCoffee = g.group(coffee);
  gameSceneWhiteboard = g.group(whiteboard);
  gameSceneLockedScreen = g.group(locked_screen);
  gameSceneTerminal = g.group(terminal);

  //gameSceneCat.visible = true;
  gameScene.visible = true;
  gameSceneKitchen.visible = false;
  gameSceneCoffee.visible = false;
  gameSceneBedroom.visible = false;
  gameSceneWhiteboard.visible = false;
  gameSceneLockedScreen.visible = false;
  gameSceneTerminal.visible = false;

  // var customKey = g.keyboard(122);
  // customKey.press = function() {
  //   console.log("Pressed");
  // };
  leftArrow = g.keyboard(37);
  upArrow = g.keyboard(38);
  rightArrow = g.keyboard(39);
  downArrow = g.keyboard(40);
  
  //Assign key `press` and release methods that
  //show and play the elf's different states
  leftArrow.press = function() {
    cat.playSequence(cat.states.walkLeft);
    cat2.playSequence(cat2.states.walkLeft);
    cat3.playSequence(cat3.states.walkLeft);
  };
  leftArrow.release = function() {
  };
  upArrow.press = function() {
  };
  upArrow.release = function() {
  };
  rightArrow.press = function() {
    cat.playSequence(cat.states.walkRight);
    cat2.playSequence(cat2.states.walkRight);
    cat3.playSequence(cat3.states.walkRight);
  };
  rightArrow.release = function() {
  };
  downArrow.press = function() {
  };
  downArrow.release = function() {
  };

  //Change the state to `play`
  g.state = play;
}

var passwordDisplayExists = false;
var terminalDisplayExists = false;
var numRemove = 0;

//The `play` function will run in a loop
function play() {
  //console.log("play");

  if (!gameSceneCoffee.visible && !gameSceneWhiteboard.visible && !gameSceneLockedScreen.visible
    && !gameSceneTerminal.visible) {
    g.move(cat);
    g.move(cat2);
    g.move(cat3);
  }

  if (!display_hint) {
    g.remove(message3);
    message3 = g.text("Toggle current hint by pressing Z!", "30px sans-serif", "white", 50, 680);
  } else {
    g.remove(message3);
    message3 = g.text(hints[hint_index], "30px sans-serif", "white", 50, 680);
  }

  //Of course you can also move a sprite the good old-fashioned way if
  //really want to!
  //cat.x += cat.vx;
  //cat.y += cat.vy;

  //If the cat is moving, display its direction
  if (Math.abs(cat.vx) > 0 || Math.abs(cat.vy) > 0) {
    message.content = "The cat is going: " + cat.direction;
    cat.loop = true;
    cat2.loop = true;
    cat3.loop = true;
  } else {
    message.content = "Use the arrow keys to move...";
    cat.loop = false;
    cat2.loop = false;
    cat3.loop = false;
  }
 // console.log(cat.x);
 // console.log(cat.y);
  /*
  Contain the cat inside the canvas.
  'contain` constrains the sprite's movement to a rectangular space
  defined by the `localBounds` property of any object.
  (`localBounds` returns an object with `x`, `y`, `width` and `height`
  properties).
  that space, `contain` returns a useful a string that will tell you which
  side the sprite hit: "left", "right". "top" or "bottom".
  */

  //var catHitsEdges = gameScene.visible ? g.contain(cat, g.stage.localBounds) : g.contain(cat2, g.stage.localBounds);
  /*  */
  living_room_contains = g.contain(cat, g.stage.localBounds);
  kitchen_contains = g.contain(cat2, g.stage.localBounds);
  bedroom_contains = g.contain(cat3, g.stage.localBounds);
  var catHitsEdges = living_room_contains || kitchen_contains || bedroom_contains;

  // if (catHitsEdges) {
  //   console.log(g.contain(cat, g.stage.localBounds));
  //   console.log(g.contain(cat2, g.stage.localBounds));
  //   console.log(g.contain(cat3, g.stage.localBounds));
  // }
  if (gameSceneKitchen.visible && cat2.x > 470 && cat2.y < 250 && cat2.x < 570) {
    gameSceneCoffee.visible = true;
  }

  if (gameSceneBedroom.visible && cat3.x > 260 && cat3.x < 460 && cat3.y < 160) {
    gameSceneWhiteboard.visible = true;
    if (hint_index === 1) {
      hint_index++;
    }
  }

  if (gameScene.visible && cat.y > 200 && cat.y < 410 && cat.x > 530) {
    if (!computerUnlocked) {
      gameSceneLockedScreen.visible = true;
      if (passwordDisplayExists) {
        g.remove(message4);
      }
      message4 = g.text(password_string, "30px sans-serif", "black", 140, 235);
      passwordDisplayExists = true;
    } else {
      gameSceneTerminal.visible = true; // TODO change this to real computer screen
      console.log("??");
    }

    // if (message4) {
    //   g.remove(message4);
    // }
    // message4 = g.text(password_string, "30px sans-serif", "black", 300, 300);
  }

  if (gameSceneTerminal.visible) {
    if (terminalDisplayExists) {
    //  g.remove(message5);
    }
    // for (var i = 0; i < terminal_archive.length; i++) {
    //   message5 = g.text(terminal_archive[i], "20px sans-serif", "white", 50, 50 + (i*20));
    // }


  //  message5 = g.text("$ " + terminal_string, "20px sans-serif", "white", 50, 50 + (20*terminal_archive.length));
    terminalDisplayExists = true;
  }

  //Display the edge of canvas that the cat hit
  if (catHitsEdges) {
    message.content
      = "The cat hit the " + catHitsEdges + " of the canvas";
      // living_room_contains = g.contain(cat, g.stage.localBounds);
      // kitchen_contains = g.contain(cat2, g.stage.localBounds);
      // bedroom_contains = g.contain(cat3, g.stage.localBounds);
      // console.log(kitchen_contains);
      // console.log(kitchen_contains === "top")
      var needs_centering = false;

      if (gameScene.visible && (living_room_contains === "top" || kitchen_contains === "top" || bedroom_contains === "top")) {
        gameScene.visible = false;
        gameSceneKitchen.visible = true;
        needs_centering = true;
      } else if (gameScene.visible && (living_room_contains === "right" || kitchen_contains === "right" || bedroom_contains === "right")) {
        gameScene.visible = false;
        gameSceneBedroom.visible = true;
        needs_centering = true;
      } else if (gameSceneKitchen.visible && (living_room_contains === "bottom" || kitchen_contains === "bottom" || bedroom_contains === "bottom")) {
        gameScene.visible = true;
        gameSceneKitchen.visible = false;
        needs_centering = true;
      } else if (gameSceneBedroom.visible && (living_room_contains === "left" || kitchen_contains === "left" || bedroom_contains === "left")) {
        gameScene.visible = true;
        gameSceneBedroom.visible = false;
        needs_centering = true;
      }

      // gameSceneCat.visible = false;
      // gameSceneCat.visible = true;
      if (needs_centering) {
        g.stage.putCenter(cat);
        g.stage.putCenter(cat2);
        g.stage.putCenter(cat3);
      }
  }

  if (closeWindow) {
    if (gameSceneLockedScreen.visible && hint_index === 0) {
      hint_index++;
    }
    if (gameSceneLockedScreen.visible) {
      password_string = " ";
      g.remove(message4);
    }

    if (gameSceneTerminal.visible) {
      terminal_string = "";
      // for (var i = 0; i < terminal_archive.length; i++) {
      //   g.remove(message5);
      // }
   //   g.remove(message5);

    }

    gameSceneCoffee.visible = false;
    gameSceneWhiteboard.visible = false;
    gameSceneLockedScreen.visible = false;
    gameSceneTerminal.visible = false;

    closeWindow = false;
    cat.y += 100;
    cat2.y += 100;
    cat3.y += 100;
  }
}

</script>
<!--Add hints or description to bottom-->
<p>Hints: Press ? to for hints!</p>
</body>

<!doctype html>
<meta charset = "utf-8">
<title>Cybersecurity Breakfast Adventure</title>
<head>
  <style>
    body {
      background-color: black;
      text-align: center;
      color: white;
      font-family: courier;
    }

    a
    {
      color: rgb(123, 213, 255);
    }
  </style>
</head>
<body>
  <h2>Cybersecurity Breakfast Adventure</h2>
<script src="ga.js"></script>
<script src="plugins.js"></script>
<script>

document.addEventListener('keydown', logKey);
var display_hint = false;
var hint_index = 0;
var hints = ["Try unlocking the computer!", "Look for a password clue in the bedroom", "Check the Caesar cipher guide for ideas!", "How many lives does a cat have?"];
var hint_has_been_viewed = [false, false, false, false];
var closeWindow = false;
var password_string = " ";
var password_incorrect_message_visible = false;
var combo_string = " ";
var combo_incorrect_message_visible = false;
var terminal_string = "";
// var allowed_password_keys = ["KeyA", "KeyB", "KeyC", "KeyD", "KeyE", "KeyF", "KeyG", "KeyH", "KeyI", "KeyJ", "KeyK", "KeyL", "KeyM", "KeyN", "KeyO", "KeyP",
//  "KeyQ", "KeyR", "KeyS", "KeyT", "KeyU", "KeyV", "KeyW", "KeyX", "KeyY", "KeyZ"];  // e.code codes
// var allowed_combo_keys = ["Digit0", "Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9"];  // e.code codes
var allowed_password_keys = [65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90]  // e.which codes
var allowed_combo_keys = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57]  // e.which codes
var computerUnlocked = false;
var lockUnlocked = false;
var terminal_archive = [];
var cat, cat2, cat3, message;

function logKey(e) {
//  console.log(e.code);
  // if (e.code === "Slash") {
  //   display_hint = !display_hint;
  //   if (hint_index === 2 && hint_has_been_viewed[hint_index]) {
  //     hint_index++;
  //   }
  // }
  if (e.code === "Escape") {
    if (gameSceneCoffee.visible || gameSceneWhiteboard.visible || gameSceneLockedScreen.visible
    || gameSceneTerminal.visible || gameSceneLock.visible || gameSceneToaster.visible
    || gameSceneFridge.visible)
    closeWindow = true;

    if (password_incorrect_message_visible) {
      password_incorrect_message_visible = false;
      g.remove(message6)
    }
  }

  if (e.code === "Slash") {
    if (document.getElementById("hintsText").innerHTML === hints[hint_index]) {
      document.getElementById("hintsText").innerHTML = "Press ? to toggle hint!";
    } else {
      document.getElementById("hintsText").innerHTML = hints[hint_index];
    }
  }

  if (gameSceneLockedScreen.visible) {
    if ((allowed_password_keys.includes(e.which) || allowed_combo_keys.includes(e.which)) && password_string.length < 18) {
      if (password_incorrect_message_visible) {
        password_incorrect_message_visible = false;
        g.remove(message6)
      }

      //password_string += e.code[3];
      password_string += String.fromCharCode(e.which);
    }

    if (e.code === "Enter") {
      console.log("Checking correctness of password...");
      check_password_correctness();
    }
    // add being able to delete a character as a quality of life update
    // if needed; lower priority than getting game to work
    if (e.code === "Backspace") {
      if (password_incorrect_message_visible) {
        password_incorrect_message_visible = false;
        g.remove(message6)
      }

      if (password_string.length <= 1) {
        password_string = " ";
      } else {
        password_string = password_string.substring(0, password_string.length-1);
      }
    }
  }

  if (gameSceneTerminal.visible) {
    if (allowed_password_keys.includes(e.code) && terminal_string.length < 40) {
      terminal_string += e.code[3];
      // update display here
      for (var i = 0; i < terminal_archive.length; i++) {
        g.remove(message5);
      }
      g.remove(message5);

      // now, update with new text!
      for (var i = 0; i < terminal_archive.length; i++) {
        message5 = g.text(terminal_archive[i], "20px sans-serif", "white", 50, 50 + (i*20));
      }
      message5 = g.text("$ " + terminal_string, "20px sans-serif", "white", 50, 50 + (20*terminal_archive.length));
    }

    if (e.code === "Enter") {
      console.log("TO DO: process commands!");
      terminal_archive.push("$ " + terminal_string);
      terminal_string = "";
      gameSceneTerminal.visible = true; // manual trigger?

      // update display here
      for (var i = 0; i < terminal_archive.length; i++) {
        g.remove(message5);
      }
      g.remove(message5);

      // now, update with new text!
      for (var i = 0; i < terminal_archive.length; i++) {
        message5 = g.text(terminal_archive[i], "20px sans-serif", "white", 50, 50 + (i*20));
      }
      message5 = g.text("$ " + terminal_string, "20px sans-serif", "white", 50, 50 + (20*terminal_archive.length));
    }
    // add being able to delete a character as a quality of life update
    // if needed; lower priority than getting game to work
    // if (e.code === "Backspace") {
    //   password_string = password_string.slice(0, -1);
    // }
  }

  if (gameSceneLock.visible) {
    if (allowed_combo_keys.includes(e.which) && combo_string.length < 18) {
      if (combo_incorrect_message_visible) {
        combo_incorrect_message_visible = false;
        g.remove(message7);
      }

      combo_string += String.fromCharCode(e.which);
    }

    if (e.code === "Enter") {
      console.log("Checking correctness of password...");
      check_password_correctness();
    }

    if (e.code === "Backspace") {
      if (combo_incorrect_message_visible) {
        combo_incorrect_message_visible = false;
        g.remove(message7)
      }

      if (combo_string.length <= 1) {
        combo_string = " ";
      } else {
        combo_string = combo_string.substring(0, combo_string.length-1);
      }
    }
  }
}


function check_password_correctness() {
  if (!computerUnlocked && gameSceneLockedScreen.visible) {
    if (password_string === " DELILAH") {
      closeWindow = true;
      console.log("Password correct!");
      computerUnlocked = true;
      document.getElementById("unlockComputer").innerHTML = "[x] Unlock the computer";
    } else {
      if (!password_incorrect_message_visible) {
        var password_incorrect_string = "Password incorrect. Please try again.";
        password_incorrect_message_visible = true;
        message6 = g.text(password_incorrect_string, "25px sans-serif", "red", 130, 150);
      }
    }
  }

  if (!lockUnlocked && gameSceneLock.visible) {
    // TODO: EDIT THE CODE IN THIS CONDITIONAL TO FIT WITH COMBO PUZZLE
    if (combo_string === " 86 37 49") {
      closeWindow = true;
      console.log("Combo correct!");
      lockUnlocked = true;
      document.getElementById("makeToast").innerHTML = "[x] Make toast";
    } else {
      if (!combo_incorrect_message_visible) {
        var combo_incorect_string = "Combo incorrect. Please try again.";
        combo_incorrect_message_visible = true;
        message7 = g.text(combo_incorect_string, "25px sans-serif", "red", 150, 450);
      }
    }
  }
}

//Create a new GA instance, and start it.
var g = ga(700, 550, setup,
  [
    "images/big-out-living.png",
    "images/new_new_kitchen.png",
    "images/step1.png",
    "images/step1_left.png",
    "images/step2.png",
    "images/step2_left.png",
    "images/standing.png",
    "images/coffee_blank_displayw_text.png",
    "images/whiteboard2.png",
    "images/bedroom.png",
    "images/locked_computer.png",
    "images/terminal.png",
    "images/zoomed_in_toaster_with_background.png",
    "images/combination_lock_with_numbers_on_cabinet.png",
    "images/fridge_display_w_text.png",
    "sounds/suburban-neighborhood.wav",
    "sounds/liquid-pour.wav",
    "sounds/memories.mp3",
    "sounds/toaster-pop-up.wav",
    "sounds/lock.wav"
  ]
);
g.start();
var music, coffee, toaster, lock;

//A `setup` function that will run only once.
//Use it for initialization tasks
function setup() {
  forest = g.sprite("images/big-out-living.png");
  kitchen = g.sprite("images/new_new_kitchen.png");
  coffee = g.sprite("images/coffee_blank_displayw_text.png")
  whiteboard = g.sprite("images/whiteboard2.png");
  bedroom = g.sprite("images/bedroom.png");
  locked_screen = g.sprite("images/locked_computer.png");
  terminal = g.sprite("images/terminal.png");
  zoomed_toaster = g.sprite("images/zoomed_in_toaster_with_background.png");
  lock_on_cabinet_w_num = g.sprite("images/combination_lock_with_numbers_on_cabinet.png");
  zoomed_fridge = g.sprite("images/fridge_display_w_text.png");



  var catFrames = [
    "images/standing.png",
    "images/step1.png",
    "images/step2.png",
    "images/standing.png",
    "images/step1_left.png",
    "images/step2_left.png"
  ];

  var walkCycle = [1, 2];

  cat = g.sprite(catFrames);
  cat2 = g.sprite(catFrames);
  cat3 = g.sprite(catFrames);

  // animation states
  cat.states = {
    walkRight: [1, 2],
    walkLeft: [4,5]
  };
  cat2.states = {
    walkRight: [1, 2],
    walkLeft: [4,5]
  };
  cat3.states = {
    walkRight: [1, 2],
    walkLeft: [4,5]
  };

  //Center the cat
  g.stage.putCenter(cat);
  g.stage.putCenter(cat2);
  g.stage.putCenter(cat3);

  // THIS STARTS CAT'S ANIMATION
  cat.fps = 5;
  cat2.fps = 5;
  cat3.fps = 5;

  cat.playSequence(walkCycle);
  cat2.playSequence(walkCycle);
  cat3.playSequence(walkCycle);

  cat.loop = false;
  cat2.loop = false;
  cat3.loop = false;

  g.fourKeyController(cat, 2, 38, 39, 40, 37);
  g.fourKeyController(cat2, 2, 38, 39, 40, 37);
  g.fourKeyController(cat3, 2, 38, 39, 40, 37);

  gameScene = g.group(forest, cat);
  gameSceneKitchen = g.group(kitchen, cat2);
  gameSceneBedroom = g.group(bedroom, cat3);
  gameSceneCoffee = g.group(coffee);
  gameSceneWhiteboard = g.group(whiteboard);
  gameSceneLockedScreen = g.group(locked_screen);
  gameSceneTerminal = g.group(terminal);
  gameSceneLock = g.group(lock_on_cabinet_w_num);
  gameSceneToaster = g.group(zoomed_toaster);
  gameSceneFridge = g.group(zoomed_fridge);

  gameScene.visible = true;
  gameSceneKitchen.visible = false;
  gameSceneCoffee.visible = false;
  gameSceneBedroom.visible = false;
  gameSceneWhiteboard.visible = false;
  gameSceneLockedScreen.visible = false;
  gameSceneTerminal.visible = false;
  gameSceneLock.visible = false;
  gameSceneToaster.visible = false;
  gameSceneFridge.visible = false;

  // var customKey = g.keyboard(122);
  // customKey.press = function() {
  //   console.log("Pressed");
  // };
  leftArrow = g.keyboard(37);
  upArrow = g.keyboard(38);
  rightArrow = g.keyboard(39);
  downArrow = g.keyboard(40);

  // background music
  music = g.sound("sounds/memories.mp3");
  toaster = g.sound("sounds/toaster-pop-up.wav");
  coffee = g.sound("sounds/liquid-pour.wav");
  lock = g.sound("sounds/lock.wav");

  //bgm.play();
  music.play();
  music.volume = 0.1;

  //Assign key `press` and release methods that
  //show and play the elf's different states
  leftArrow.press = function() {
    cat.playSequence(cat.states.walkLeft);
    cat2.playSequence(cat2.states.walkLeft);
    cat3.playSequence(cat3.states.walkLeft);

  };
  leftArrow.release = function() {
  };
  upArrow.press = function() {
  };
  upArrow.release = function() {
  };
  rightArrow.press = function() {
    cat.playSequence(cat.states.walkRight);
    cat2.playSequence(cat2.states.walkRight);
    cat3.playSequence(cat3.states.walkRight);
  };
  rightArrow.release = function() {
  };
  downArrow.press = function() {
  };
  downArrow.release = function() {
  };

  //Change the state to `play`
  g.state = play;

}

var passwordDisplayExists = false;
var terminalDisplayExists = false;
var comboDisplayExists = false;
var numRemove = 0;

//The `play` function will run in a loop
function play() {

  if (!gameSceneCoffee.visible && !gameSceneWhiteboard.visible && !gameSceneLockedScreen.visible
    && !gameSceneTerminal.visible && !gameSceneLock.visible && !gameSceneToaster.visible
    && !gameSceneFridge.visible) {
    g.move(cat);
    g.move(cat2);
    g.move(cat3);
  }

  //If the cat is moving, play walking animation
  if (Math.abs(cat.vx) > 0 || Math.abs(cat.vy) > 0) {
    cat.loop = true;
    cat2.loop = true;
    cat3.loop = true;
  } else {
    cat.loop = false;
    cat2.loop = false;
    cat3.loop = false;
  }

  /*
  Contain the cat inside the canvas.
  'contain` constrains the sprite's movement to a rectangular space
  defined by the `localBounds` property of any object.
  (`localBounds` returns an object with `x`, `y`, `width` and `height`
  properties).
  that space, `contain` returns a useful a string that will tell you which
  side the sprite hit: "left", "right". "top" or "bottom".
  */

  living_room_contains = g.contain(cat,
    {
      x: 0,
      y: 0,
      width: 700,
      height: 500
    }
  );

  kitchen_contains = g.contain(cat2,
    {
      x: 0,
      y: 0,
      width: 700,
      height: 500
    }
  );

  bedroom_contains = g.contain(cat3,
    {
      x: 0,
      y: 0,
      width: 700,
      height: 500
    }
  );
  var catHitsEdges = living_room_contains || kitchen_contains || bedroom_contains;

  if (gameSceneKitchen.visible && cat2.x > 470 && cat2.y < 230 && cat2.x < 570) {
    gameSceneCoffee.visible = true;
  }

  if (gameSceneKitchen.visible && cat2.x > 250 && cat2.x < 300 && cat2.y < 230) {
    gameSceneToaster.visible = true;
  }

  if (gameSceneKitchen.visible && cat2.x > 20 && cat2.x < 90 && cat2.y < 250) {
    if (!lockUnlocked) {
      gameSceneLock.visible = true;
      if (comboDisplayExists) {
        g.remove(message8);
      }
      message8 = g.text(combo_string, "30px sans-serif", "black", 200, 410);
      comboDisplayExists = true;
    }
  }

  if (gameSceneKitchen.visible && cat2.x > 90 && cat2.x < 180 && cat2.y < 250) {
    gameSceneFridge.visible = true;
  }

  if (gameSceneBedroom.visible && cat3.x > 260 && cat3.x < 460 && cat3.y < 160) {
    gameSceneWhiteboard.visible = true;
    if (hint_index === 1) {
      hint_index++;
    }
  }

  if (gameScene.visible && cat.y > 200 && cat.y < 410 && cat.x > 530) {
    if (!computerUnlocked) {
      gameSceneLockedScreen.visible = true;
      if (passwordDisplayExists) {
        g.remove(message4);
      }
      message4 = g.text(password_string, "30px sans-serif", "black", 140, 235);
      passwordDisplayExists = true;
    } else if (!gameSceneTerminal.visible){
      gameSceneTerminal.visible = true; // TODO change this to real computer screen
      console.log("Pausing game....");
      g.pause();

      // console.log("??");
    }

    // if (message4) {
    //   g.remove(message4);
    // }
    // message4 = g.text(password_string, "30px sans-serif", "black", 300, 300);
  }

  if (gameSceneTerminal.visible) {
    if (terminalDisplayExists) {
    //   for (var i = 0; i < terminal_archive.length; i++) {
    //   message5 = g.text(terminal_archive[i], "20px sans-serif", "white", 50, 50 + (i*20));
    // }
      // for (var i = 0; i < terminal_archive.length; i++) {
      //   g.remove(message5);
      // }
      // g.remove(message5);
    } else {
      for (var i = 0; i < terminal_archive.length; i++) {
        message5 = g.text(terminal_archive[i], "20px sans-serif", "white", 50, 50 + (i*20));
      }
      message5 = g.text("$ " + terminal_string, "20px sans-serif", "white", 50, 50 + (20*terminal_archive.length));
      terminalDisplayExists = true;
      console.log("displaying text?");
    }
    // for (var i = 0; i < terminal_archive.length; i++) {
    //   message5 = g.text(terminal_archive[i], "20px sans-serif", "white", 50, 50 + (i*20));
    // }
    // var currTerminalString = "";
    // for (var i = 0; i < terminal_archive.length; i++) {
    //   currTerminalString += terminal_archive[i] + '\n';
    // }


  }

  //Display the edge of canvas that the cat hit
  if (catHitsEdges) {
      var needs_centering = false;

      if (gameScene.visible && (living_room_contains === "top" || kitchen_contains === "top" || bedroom_contains === "top")) {
        gameScene.visible = false;
        gameSceneKitchen.visible = true;
        needs_centering = true;
      } else if (gameScene.visible && (living_room_contains === "right" || kitchen_contains === "right" || bedroom_contains === "right")) {
        gameScene.visible = false;
        gameSceneBedroom.visible = true;
        needs_centering = true;
      } else if (gameSceneKitchen.visible && (living_room_contains === "bottom" || kitchen_contains === "bottom" || bedroom_contains === "bottom")) {
        gameScene.visible = true;
        gameSceneKitchen.visible = false;
        needs_centering = true;
      } else if (gameSceneBedroom.visible && (living_room_contains === "left" || kitchen_contains === "left" || bedroom_contains === "left")) {
        gameScene.visible = true;
        gameSceneBedroom.visible = false;
        needs_centering = true;
      }

      if (needs_centering) {
        g.stage.putCenter(cat);
        g.stage.putCenter(cat2);
        g.stage.putCenter(cat3);
      }
  }

  if (closeWindow) {
    console.log("Closing window!");
    if (gameSceneLockedScreen.visible && hint_index === 0) {
      hint_index++;
    }
    if (gameSceneLockedScreen.visible) {
      password_string = " ";
      g.remove(message4);
      gameSceneLockedScreen.visible = false;
    }

    if (gameSceneTerminal.visible) {
      terminal_string = "";
      for (var i = 0; i < terminal_archive.length; i++) {
        g.remove(message5);
      }
      g.remove(message5);
      gameSceneTerminal.visible = false;
      terminalDisplayExists = false;
    }

    gameSceneToaster.visible = false;
    gameSceneLock.visible = false;
    gameSceneFridge.visible = false;
    gameSceneCoffee.visible = false;
    gameSceneWhiteboard.visible = false;
  //  gameSceneLockedScreen.visible = false;
    //gameSceneTerminal.visible = false;

    closeWindow = false;
    cat.y += 100;
    cat2.y += 100;
    cat3.y += 100;
  }
}

</script>
<!--Add hints or description to bottom-->
  <p id="hintsText">Hints: press ? to toggle!</p>
  <div id="tastList">
    <p>Remaining tasks:</p>
    <p id="unlockComputer">- Unlock the computer</p>
    <p id="makeToast">- Make toast</p>
    <p id="openFridge">- Open the fridge</p>
    <p id="makeCoffee">- Make coffee</p>
  </div>
  <p>Instructions: Use the arrow keys to navigate locations and complete your tasks. If you find yourself at a pop-up screen within the game, press Escape to close it and return to the overworld. For text-based prompts, hit Enter to submit your input.</p>
  <div id="resources">
    <p>Resources</p>
    <p><a href="guides/caesar_ciphers.pdf" target="_blank" rel="noopener noreferrer">On Caesar Ciphers</a></p>
    <p><a href="guides/number_systems_and_ascii.pdf" target="_blank" rel="noopener noreferrer">Number Systems and ASCII</a></p>
    <p><a href="guides/sql.pdf" target="_blank" rel="noopener noreferrer">A Light Intro on SQL</a></p>
  </div>
</body>
